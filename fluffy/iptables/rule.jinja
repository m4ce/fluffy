iptables -t {{ rule['table'] }} -A {{ rule['chain'] }}{% if rule['in_interface'] %} --in-interface {{ rule['in_interface'] }}{% endif %}{% if rule['out_interface'] %} --out-interface {{ rule['out_interface'] }}{% endif %}{% if rule['protocol'] %}{% if rule['negate_protocol'] %} !{% endif %} --protocol {{ rule['protocol'] }}{% endif %}{% if rule['tcp_flags'] %}{% if rule['negate_tcp_flags'] %} !{% endif %} --tcp-flags {{ rule['tcp_flags'] }}{% endif %}{% if rule['ctstate'] %} --match conntrack{% if rule['negate_ctstate'] %} !{% endif %} --ctstate {{ rule['ctstate']|join(',') }}{% if rule['state'] %} --match state --state {{ rule['state'] }}{% endif %}{% endif %}{% if rule['src_address_range'] or rule['dst_address_range'] %} --match iprange{% endif %}{% if rule['src_address_range'] %}{% if rule['negate_src_address_range'] %} !{% endif %} --src-range {{ rule['src_address_range']|join(',') }}{% endif %}{% if rule['dst_address_range'] %}{% if rule['negate_dst_address_range'] %} !{% endif %} --dst-range {{ rule['dst_address_range']|join(',') }}{% endif %}{% if rule['src_address'] %}{% if rule['negate_src_address'] %} !{% endif %} --source {{ rule['src_address']|join(',') }}{% endif %}{% if rule['dst_address'] %}{% if rule['negate_dst_address'] %} !{% endif %} --destination {{ rule['dst_address']|join(',') }}{% endif %}{% if (rule['src_service'] and rule['src_service']|length > 1) or (rule['dst_service'] and rule['dst_service']|length > 1) %} --match multiport{% endif %}{% if rule['src_service'] %}{% if rule['negate_src_service'] %} !{% endif %} --source-port {{ rule['src_service']|join(',') }}{% endif %}{% if rule['dst_service'] %}{% if rule['negate_dst_service'] %} !{% endif %} --destination-port {{ rule['dst_service']|join(',') }}{% endif %}{% if rule['icmp_type'] %}{% if rule['negate_icmp_type'] %} !{% endif %} --icmp-type '{{ rule['icmp_type'] }}'{% endif %}{% if rule['limit'] %} --match limit --limit {{ rule['limit'] }}{% endif %}{% if rule['limit_burst'] %} --limit-burst {{ rule['limit_burst'] }}{% endif %}{% if rule['comment'] %} --match comment --comment '{{ rule['comment'] }}'{% endif %} --jump {% if rule['action'] %}{{ rule['action'] }}{% else %}{{ rule['jump'] }}{% endif %}{% if rule['log_prefix'] %} --log-prefix '{{ rule['log_prefix'] }}'{% endif %}{% if rule['log_level'] %} --log-level {{ rule['log_level'] }}{% endif %}{% if rule['reject_with'] %} --reject-with {{ rule['reject_with'] }}{% endif %}{% if rule['to_dst'] %} --to-destination {{ rule['to_dst'] }}{% endif %}{% if rule['to_src'] %} --to-source {{ rule['to_src'] }}{% endif %}{% if rule['set_mss'] %} --set-mss {{ rule['set_mss'] }}{% endif %}{% if rule['clamp_mss_to_pmtu'] %} --clamp-mss-to-pmtu{% endif %}
